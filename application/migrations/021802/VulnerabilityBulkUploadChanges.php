<?php
/**
 * Copyright (c) 2012 Endeavor Systems, Inc.
 *
 * This file is part of OpenFISMA.
 *
 * OpenFISMA is free software: you can redistribute it and/or modify it under the terms of the GNU General Public
 * License as published by the Free Software Foundation, either version 3 of the License, or (at your option) any later
 * version.
 *
 * OpenFISMA is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without even the implied
 * warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License for more
 * details.
 *
 * You should have received a copy of the GNU General Public License along with OpenFISMA.  If not, see
 * {@link http://www.gnu.org/licenses/}.
 */

/**
 * Create the database table, vulnerability_bulk_upload_status.
 *
 * @author     Xue-Wei Tang <xue-wei.tang@endeavorsystems.com>
 * @copyright  (c) Endeavor Systems, Inc. 2012 {@link http://www.endeavorsystems.com}
 * @license    http://www.openfisma.org/content/license GPLv3
 * @package    Migration
 */
class Application_Migration_021802_VulnerabilityBulkUploadChanges extends Fisma_Migration_Abstract
{
    /**
     * Migrate.
     */
    public function migrate()
    {
        $this->message("Creating Vulnerability Upload Staus table...");
        $this->getHelper()->exec(
            "CREATE TABLE vulnerability_bulk_upload_status
             (
                 id             BIGINT (20)   NOT NULL AUTO_INCREMENT
                ,userid         BIGINT (20)   NOT NULL
                ,sessionid      VARCHAR (50)  NOT NULL
                ,eventdt        DATETIME      NOT NULL
                ,eventname      VARCHAR (30)  NOT NULL
                ,filename       VARCHAR (100) NOT NULL
                ,scantype       VARCHAR (30)
                ,uploadid       BIGINT (20)
                ,creatednum     INTEGER
                ,reopenednum    INTEGER
                ,suppressednum  INTEGER
                ,eventmessage   VARCHAR(500)
                ,PRIMARY KEY (id)
            )"
        );

        $this->message("Altering Vulnerability Upload table...");
        $this->getHelper()->exec(
             "ALTER TABLE vulnerability_upload ADD
                 ( bulkuploadid  BIGINT (20) DEFAULT 0 ) "
        );

        $this->message("Altering Vulnerability table...");
        $this->getHelper()->exec(
            "ALTER TABLE vulnerability ADD
                 ( uploadids      TEXT
                  ,bulkuploadids  TEXT
              ) "
        );
    }
}

