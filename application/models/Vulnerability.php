<?php

/**
 * Vulnerability
 * 
 * This class has been auto-generated by the Doctrine ORM Framework
 * 
 * @package    ##PACKAGE##
 * @subpackage ##SUBPACKAGE##
 * @author     ##NAME## <##EMAIL##>
 * @version    SVN: $Id: Builder.php 6401 2009-09-24 16:12:04Z guilhermeblanco $
 */
class Vulnerability extends BaseVulnerability
{
    /**
     * Valid state transitions for any vulnerability object. 
     * 
     * The key is the "from" state and the value is an array of the valid "to" states. Any transition not 
     * specified here is considered invalid.
     * 
     * @var array
     */
    static private $_validStateTransitions = array(
        'AR' => array('CLOSED'),
        'FP' => array('CLOSED'),
        'CLOSED' => array('OPEN'),
        'OPEN' => array('AR', 'CLOSED', 'FP')
    );

    /**
     * Returns true if it is valid for a vulnerability to go from one state to another
     * 
     * @param string $fromState
     * @param string $toState
     * @return bool
     */
    public function isValidStateTransition($fromState, $toState)
    {
        if (isset(self::$_validStateTransitions[$fromState]) && 
            in_array($toState, self::$_validStateTransitions[$fromState])) {
            
            return true;
        } else {
            return false;
        }
    }

    /**
     * Override BaseVulnerability::setUp to include custom mutators
     *
     * @return void
     */
    public function setUp()
    {
        parent::setUp();

        $this->hasMutator('status', 'setStatus');
    }

    /**
     * Custom mutator to set the closedTs field when status changes to CLOSED
     *
     * @param string $value Value to set
     * @return void
     */
    public function setStatus($value)
    {
        // Enforce state transition logic
        if (!$this->isValidStateTransition($this->status, $value)) {
            throw new Fisma_Zend_Exception("Invalid state transition for vulnerability from {$this->status} to $value");
        }

        if ($value == 'CLOSED') {
            $this->closedTs = Fisma::now();
        }

        // Update the value
        $this->_set('status', $value);
    }
}
