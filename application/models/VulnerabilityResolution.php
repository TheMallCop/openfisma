<?php

/**
 * VulnerabilityResolution
 * 
 * This class has been auto-generated by the Doctrine ORM Framework
 * 
 * @package    ##PACKAGE##
 * @subpackage ##SUBPACKAGE##
 * @author     ##NAME## <##EMAIL##>
 */
class VulnerabilityResolution extends BaseVulnerabilityResolution
{
    /**
     * Build the query for resolution dependency
     * 
     * @return Doctrine_Query
     */
    public function resolutionQuery()
    {
        $resolutionQuery = Doctrine_Query::create()
                                         ->select('id')
                                         ->from('Vulnerability')
                                         ->where('resolutionId = ?', $this->id);
        return $resolutionQuery;
    }
 
    public function preDelete($event, $resolution = null)
    {
        $resolution = (isset($resolution)) ? $resolution : $this->resolutionQuery();        
        $resolutionCount = $resolution->count();
        if ($resolutionCount > 0) {
            throw new Fisma_Zend_Exception_User(
                'This resolution cannot be deleted because it has vulnerabilities assigned to it.'
            );
        }
    }
}
