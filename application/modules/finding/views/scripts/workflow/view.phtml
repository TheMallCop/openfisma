<?php
$editMode = (
    $this->acl()->hasPrivilegeForClass('create', 'Evaluation') ||
    $this->acl()->hasPrivilegeForClass('update', 'Evaluation') ||
    $this->acl()->hasPrivilegeForClass('delete', 'Evaluation')
);

if ($editMode):
    $saveButton = new Fisma_Yui_Form_Button(
        'saveButton',
        array(
            'label' => 'Save',
            'onClickFunction' => 'Fisma.FindingWorkflow.forceSubmit'
        )
    );
    $cancelButton = new Fisma_Yui_Form_Button_Link(
        'cancelButton',
        array(
            'value' => 'Cancel',
            'href' => '/finding/workflow/view'
        )
    );
endif;

$workflowTitle = 'The workflow title is used to distinguish the workflow step and to auto-create the status message. '
               . 'The status message adds the word awaiting to the beginning of the workflow title. For example, if '
               . 'you create a workflow step called \\"CISO Approval of Evidence Package\\", the status message '
               . 'becomes \\"Awaiting CISO Approval of Evidence Package\\".';
$chartLabel = 'The chart label is used to designate the workflow step in short notation. The chart label is used for '
            . 'graphs, reports, and searching. For example, if the chart label for workflow step ISSO Approval of '
            . 'Mitigation Strategy is set to \\"MS ISSO\\" then the graph will identify the workflow step as \\"MS ISSO'
            . '\\" and the user will be able to search for items currently in the \\"MS ISSO\\" status.';
$statusMessage = 'The status message is a brief synopsis of the current status used to give additional context to the '
               . 'user rather than showing them an acronym. For example, the status message \\"Awaiting ISSO Approval '
               . 'of Mitigation Strategy\\" informs the user what has to happen before the status is changed.';
$onTime = 'The on time period sets the number of calendar days that the workflow step is considered on time. Once the '
        . 'period has lapsed, the workflow step becomes overdue. For example, if the period is set to 7, then the '
        . 'action will remain on-time for 7 calendar days.';
?>

<form
    id='finding_workflow'
    name='finding_workflow'
    action='/finding/workflow/modify'
    onsubmit='Fisma.FindingWorkflow.submitHandler'
    method='post'
>
<input type='hidden' name='forceSubmit' value='false' />

<?php if ($editMode): ?>
<div class='buttonBar'>
    <?php echo $this->escape($saveButton, 'none'); ?>
    <?php echo $this->escape($cancelButton, 'none'); ?>
    <img style='display:none' src='/images/loading_bar.gif' />
</div>
<?php endif; ?>

<?php Fisma_Format_Section::startSection('Finding Workflow'); ?>

<?php if ($editMode): ?>
<div id='changeQueue'>
    <div class='messageBox attention'>
        <ul>
            <li>You are editing a workow, your changes may affect other users of the application.</li>
            <li>Changes you make cannot be undone.</li>
            <li>Changes will not take affect until you click the "Save" button.</li>
            <li>You may cancel your changes if you do not wish to save them.</li>
        </ul>
    </div>

    <div class='approvalHeader'><b>Change Window</b></div>
    <div class='approval'>
        <div class='approvalStep highlight'>
            <input type='hidden' name='changeQueue' />
            You have made the following change(s), please review before saving:
        </div>
    </div>
</div>
<?php endif; ?>

<div class='stepBlock incidentStep completedIncidentStep'>
    <div class='incidentCardinality'>1</div>
    <h1>NEW - New</h1>
    <table>
        <tr>
            <td><?php
                echo $this->escape(new Fisma_Yui_Tooltip(
                    "new_workflowtitle",
                    'Workflow Title',
                    $workflowTitle
                ), 'none');
            ?></td>
            <td>New</td></tr>
        <tr>
            <td><?php
                echo $this->escape(new Fisma_Yui_Tooltip(
                    "new_chartlabel",
                    'Chart Label',
                    $chartLabel
                ), 'none');
            ?></td>
            <td>NEW</td>
        </tr>
        <tr>
            <td><?php
                echo $this->escape(new Fisma_Yui_Tooltip(
                    "new_statusmessage",
                    'Status Message',
                    $statusMessage
                ), 'none');
            ?></td>
            <td>Awaiting Mitigation Strategy</td>
        </tr>
        <tr>
            <td><?php
                echo $this->escape(new Fisma_Yui_Tooltip(
                    "new_ontime",
                    'On Time',
                    $onTime
                ), 'none');
            ?></td>
            <td>30</td>
        </tr>
        <tr>
            <td>Description</td>
            <td>
                The finding has been created but nobody has determined an effective mitigation strategy.
                Once a user picks a mitigation strategy the finding will move from NEW to DRAFT.
                You have 30 days to choose a mitigation strategy before this item becomes overdue.
            </td>
        </tr>
    </table>
</div>

<div class='stepBlock incidentStep completedIncidentStep'>
    <div class='incidentCardinality'>2</div>
    <h1>DRAFT - Draft</h1>
    <table>
        <tr>
            <td><?php
                echo $this->escape(new Fisma_Yui_Tooltip(
                    "draft_workflowtitle",
                    'Workflow Title',
                    $workflowTitle
                ), 'none');
            ?></td>
            <td>Draft</td></tr>
        <tr>
            <td><?php
                echo $this->escape(new Fisma_Yui_Tooltip(
                    "draft_chartlabel",
                    'Chart Label',
                    $chartLabel
                ), 'none');
            ?></td>
            <td>DRAFT</td>
        </tr>
        <tr>
            <td><?php
                echo $this->escape(new Fisma_Yui_Tooltip(
                    "draft_statusmessage",
                    'Status Message',
                    $statusMessage
                ), 'none');
            ?></td>
            <td>Awaiting Mitigation Strategy Submission</td>
        </tr>
        <tr>
            <td><?php
                echo $this->escape(new Fisma_Yui_Tooltip(
                    "draft_ontime",
                    'On Time',
                    $onTime
                ), 'none');
            ?></td>
            <td>30</td>
        </tr>
        <tr>
            <td>Description</td>
            <td>
                The finding is awaiting a completed mitigation strategy. Once a user submits the mitigation strategy
                for approval the finding will move from DRAFT to mitigation strategy approval.
                You have 30 days to define and submit a mitigation strategy.
            </td>
        </tr>
    </table>
</div>

<div class='stepBlock incidentStep currentIncidentStep'>
    <div class='incidentCardinality'>3</div>
    <h1>MSA - Mitigation Strategy Approval</h1>
    <?php
        echo $this->escape(new Fisma_Yui_InteractiveOrderedList(
            "action",
            "finding",
            "workflow/step.phtml",
            $this->msList,
            $editMode,
            array(
                'onAppend' => "Fisma.FindingWorkflow.appendHandler",
                'endDrag' => "Fisma.FindingWorkflow.endDragHandler"
            )
        ), 'none');
    ?>
</div>

<div class='stepBlock incidentStep completedIncidentStep'>
    <div class='incidentCardinality'>4</div>
    <h1>EN - Evidence Needed</h1>
    <table>
        <tr>
            <td><?php
                echo $this->escape(new Fisma_Yui_Tooltip(
                    "new_workflowtitle",
                    'Workflow Title',
                    $workflowTitle
                ), 'none');
            ?></td>
            <td>Evidence Needed</td></tr>
        <tr>
            <td><?php
                echo $this->escape(new Fisma_Yui_Tooltip(
                    "new_chartlabel",
                    'Chart Label',
                    $chartLabel
                ), 'none');
            ?></td>
            <td>EN</td>
        </tr>
        <tr><td><?php
                echo $this->escape(new Fisma_Yui_Tooltip(
                    "en_statusmessage",
                    'Status Message',
                    $statusMessage
                ), 'none');
            ?></td><td>Awaiting Evidence Package Submission</td></tr>
        <tr>
            <td>Description</td>
            <td>
                The finding is in progress and will become overdue if the Estimated Completion Date has passed.
                Once the user gathers sufficient evidence to prove the finding was remediated according to
                the mitigation strategy it may be submitted for approval.
            </td>
        </tr>
    </table>
</div>

<div class='stepBlock incidentStep currentIncidentStep'>
    <div class='incidentCardinality'>5</div>
    <h1>EA - Evidence Approval</h1>
    <?php
        echo $this->escape(new Fisma_Yui_InteractiveOrderedList(
            "evidence",
            "finding",
            "workflow/step.phtml",
            $this->evList,
            $editMode,
            array(
                'onAppend' => "Fisma.FindingWorkflow.appendHandler",
                'endDrag' => "Fisma.FindingWorkflow.endDragHandler"
            )
        ), 'none');
    ?>
</div>

<div class='stepBlock incidentStep completedIncidentStep'>
    <div class='incidentCardinality'>6</div>
    <h1>CLOSED - Closed</h1>
    <table>
        <tr>
            <td><?php
                echo $this->escape(new Fisma_Yui_Tooltip(
                    "closed_workflowtitle",
                    'Workflow Title',
                    $workflowTitle
                ), 'none');
            ?></td>
            <td>Closed</td></tr>
        <tr>
            <td><?php
                echo $this->escape(new Fisma_Yui_Tooltip(
                    "closed_chartlabel",
                    'Chart Label',
                    $chartLabel
                ), 'none');
            ?></td>
            <td>CLOSED</td>
        </tr>
        <tr><td><?php
                echo $this->escape(new Fisma_Yui_Tooltip(
                    "closed_statusmessage",
                    'Status Message',
                    $statusMessage
                ), 'none');
            ?></td><td>Finding Officially Closed</td></tr>
        <tr>
            <td>Description</td>
            <td>
                The finding is officially closed and cannot be edited.
            </td>
        </tr>
    </table>
</div>

<?php Fisma_Format_Section::stopSection(); ?>
</form>
