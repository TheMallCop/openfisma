<?php 
Format_Section::startSection('Artifacts (' . count($this->ev_evals) . ')');
if (count($this->ev_evals) == 0) {
    print "<p><i>There are no artifacts for this finding.</i></p>";
}
foreach ($this->ev_evals as $e) {
    $evidence = $e->ev;
    $evaluation = $e->eval;
    $comment = new Comments();
?>
    <form action="/remediation/evidence/id/<?php echo $evidence['id'];?>" method="post"
     name='eval_ev<?php echo $evidence['id'];?>'>
        <table class="keyValues">
            <tr>
                <td colspan="2">
                    Evidence Submitted by 
                    <?php echo $evidence['submitted_by'];?> on <?php echo $evidence['submit_ts'];?>
                </td>
            </tr>
            <tr> 
                <td colspan=2>
                    <b>Evidence:&nbsp;</b>
                    <?php 
                        $url = $evidence['submission'];
                        $ev_path[] = $evidence['submission'];
                        $ev_path[] ='evidence' . '/' . $evidence['poam_id']. '/'. $evidence['submission'];
                        $link = '%filename%';
                        foreach( $ev_path as $path ) {
                            if(file_exists($path) ) {
                                $url = str_replace('\\', '/',$path);
                                $link = "<a href='/{$url}' target='_blank'>%filename%</a>";
                            }
                        }
                        echo str_replace('%filename%',basename($url),$link);
                    ?>
                </td>
            </tr>
            <?php 
            $value = 'NONE';
            $editable = true;
            $eval_model = new Evaluation();
            $ev_evallist = $eval_model->getEvalList('EVIDENCE');
            foreach($ev_evallist as $k=>$v) {
                $name = &$v['name'];
                if(isset($evaluation[$name])) {
                    if( $evaluation[$name]['group'] != 'EVIDENCE' ) {
                        continue;
                    }
                    $value = &$evaluation[$v['name']]['decision'];
                    $username = isset($evaluation[$name]['username'])?$evaluation[$name]['username']:'...';
                    $date = isset($evaluation[$name]['date'])?$evaluation[$name]['date']:'';
                }else{
                    if($value == 'DENIED' ){
                        $value = 'EXCLUDED';
                    }else if($value == 'APPROVED') {
                        $value = 'NONE';
                    }
                }
                echo  "<tr><td><b>$name:&nbsp;</b>";
                if($value=='NONE' && $editable){
                    if($e->acl->isAllowed('remediation',$v['function'])){
                        echo '<input type="hidden" name="evaluation" value="'.$v['id'].'"/>';
                        echo '<input type="hidden" name="precedence" value="'.$v['precedence_id'].'"/>';
                        echo '<input type="hidden" name="topic" value="" />';
                        echo '<input type="hidden" name="reject" value="" />';
                        echo '<input type="hidden" name="comment" value="" />';
                        echo '<input type="hidden" name="decision" value="APPROVE" />';
                        echo '<input type="submit" value="APPROVE" />';
                        echo '<input type="button" value="DENY" '.
                            'onclick="ev_deny(document.eval_ev'.$evidence['id'].');" />';
                    }else{
                        echo "$value </td>";
                    }
                    $editable=false;
                }else{
                    echo "$value </td>";
                    if( $value == 'APPROVED' ) {
                        echo "<td> -- <i> by $username ON $date </i></td>";
                    }else if($value == 'DENIED') {
                        $row = $comment->fetchRow('poam_evaluation_id = '.$evaluation[$name]['eval_id']);
                        echo "<td>";
                        if( !empty($row) ) {
                            echo "<b>{$row->content}</b>";
                        }
                        echo " -- <i> by $username ON $date </i></td>";
                    }
                }
                echo "</tr>";
            }
            ?>
        </table>
    </form>
<?php } ?>

<?php
if('EN' == $this->poam['status'] && $this->acl->isAllowed('remediation','update_evidence') ){
    echo 
    '<button id="up_evidence" onclick ="upload_evidence();">Upload Evidence</button>';
}
?>
