<?php 
Fisma_Format_Section::startSection('Artifacts (' . count($this->ev_evals) . ')');
if (count($this->ev_evals) == 0) {
    print "<p><i>There are no artifacts for this finding.</i></p>";
}
foreach ($this->ev_evals as $e) {
    $evidence = $e['ev'];
    $evaluation = $e['eval'];
    $comment = new Comments();
?>
        <div class="approvalHeader">
            <b>File: </b>
            <a href='/remediation/downloadevidence/id/<?php echo $evidence['id'];?>' target='_blank'><?php echo $evidence['submission']; ?></a>
            (submitted by <?php echo $evidence['submitted_by']; ?> on <?php echo $evidence['submit_ts']; ?>)
        </div>
        <div class="approval">
            <?php 
            $value = 'NONE';
            $editable = true;
            $eval_model = new Evaluation();
            $ev_evallist = $eval_model->getEvalList('EVIDENCE');
            foreach($ev_evallist as $k=>$v) {
                $name = &$v['name'];
                if(isset($evaluation[$name])) {
                    if( $evaluation[$name]['group'] != 'EVIDENCE' ) {
                        continue;
                    }
                    $value = &$evaluation[$v['name']]['decision'];
                    $username = isset($evaluation[$name]['username'])?$evaluation[$name]['username']:'...';
                    $date = isset($evaluation[$name]['date'])?$evaluation[$name]['date']:'';
                } else {
                    if($value == 'DENIED' ) {
                        $value = 'EXCLUDED';
                    } elseif ($value == 'APPROVED') {
                        $value = 'NONE';
                    }
                }
                echo  "<p><b>$name:&nbsp;</b>";
                if($value=='NONE' && $editable){
                    if($e['acl']->isAllowed('remediation',$v['function'])) {
                        echo '<input type="hidden" name="evaluation" value="'.$v['id'].'"/>';
                        echo '<input type="hidden" name="evidence_id" value="'.$evidence['id'].'"/>';
                        echo '<input type="hidden" name="precedence" value="'.$v['precedence_id'].'"/>';
                        echo '<input type="hidden" name="topic" value="" />';
                        echo '<input type="hidden" name="reject" value="" />';
                        echo '<input type="hidden" name="comment" value="" />';
                        echo '<input type="hidden" name="decision" value="APPROVE" />';
                        echo '<input name="submit_ea" type="submit" value="APPROVE"
                            onclick="return form_confirm(document.finding_detail, \'approve ' . $name . '\');">&nbsp;';
                        echo '<input type="button" value="DENY" onclick="ev_deny(document.finding_detail);">';
                    } else {
                        echo "$value";
                    }
                    $editable=false;
                } else {
                    if ($value == 'APPROVED') {
                        echo "<span class='approved'>$value ($username on $date)</span>";
                    } elseif ($value == 'DENIED') {
                        $row = $comment->fetchRow('poam_evaluation_id = '.$evaluation[$name]['eval_id']);
                        echo "<span class='denied'>$value";
                        if( !empty($row) ) {
                            echo " &mdash; $row->content ";
                        }
                        echo "($username on $date)</span>";
                    } else {
                        echo "$value";
                    }
                }
                echo "</p>";
            }
            ?>
        </div>
<?php
}

$uploadEvidenceButton = new Fisma_Yui_Form_Button('uploadEvidenceButton',
                                            array('value' => 'Upload Evidence', 
                                                  'onClickFunction' => 'upload_evidence'));
if('EN' != $this->poam['status'] || !$this->acl->isAllowed('remediation', 'update_evidence')) {
    $uploadEvidenceButton->readOnly = true;
}
echo "<p>Evidence can only be uploaded if the finding is in 'EN' status and if you have the required role.</p>
      <div class='toolbar'>$uploadEvidenceButton</div>";
?>
