<?php
    Fisma_Format_Section::startSection("Mitigation Strategy"); 
    $finding = $this->finding;
?>
<p>
    <b>Type:</b>

    <span type="select" name="finding[type]" href="/metainfo/list/o/type/format/html/" id="type"
        <?php 
            if (('NEW' == $finding->status || 'DRAFT' == $finding->status) 
                && Fisma_Acl::hasPrivilege('finding','update_course_of_action')) {
                echo 'class="editable" target="type"';
            }
        ?>>
        <?php echo $finding->type;?>&nbsp;&nbsp;
    </span>
</p>
            
<p>
    <b target="mitigation_strategy"
        <?php 
            if (in_array($finding->status, array('NEW', 'DRAFT'))
                && Fisma_Acl::hasPrivilege('finding','update_course_of_action')) {
               echo 'class="editable"';
            }
        ?>>
        Description:
    </b>
</p>
<div name="finding[mitigationStrategy]" id="mitigation_strategy" type="textarea">
    <?php echo $finding->mitigationStrategy; ?> 
</div>

<p>
    <b
        <?php
            if(in_array($finding->status, array('NEW', 'DRAFT'))
                && Fisma_Acl::hasPrivilege('finding', 'update_resources')) {
                echo 'class="editable" target="resources_required"';
            } 
        ?>>
        Resources Required:
    </b>
</p>
<div name="finding[resourcesRequired]" id="resources_required" type="textarea"> 
    <?php echo $finding->resourcesRequired; ?> 
</div>

<?php 
if (empty($finding->expectedCompletionDate) || $finding->expectedCompletionDate == '0000-00-00') {
    $ecdDate = $finding->currentEcd;
} else {
    $ecdDate = $finding->expectedCompletionDate;
}
?>
<p>
    <b>Expected Completion Date:</b>
    <span name="finding[expectedCompletionDate]" id="expectedCompletionDate" type="text"
        <?php 
            if (Fisma_Acl::hasPrivilege('finding', 'update_course_of_action')
                && in_array($finding->status, array('NEW', 'DRAFT'))) {
                echo ' class="date editable" target="expectedCompletionDate">';
            } else {
                echo '>';
            }
            echo $ecdDate ? $ecdDate : '0000-00-00';
        ?>
    </span>
</p>

<p>
    <b>Actual Completion Date: </b>
    <span>
        <?php 
            if (empty($finding->actualCompletionDate) || $finding->actualCompletionDate == '0000-00-00') {
                echo '(not completed)';
            } else {
                echo $finding->actualCompletionDate;
            }
        ?>
    </span>
</p>
    
<?php Fisma_Format_Section::stopSection(); ?>

<?php 
Fisma_Format_Section::startSection("Mitigation Strategy Approval");
$postAction = "/panel/remediation/sub/msa/id/" . $finding->id;

$array = array('type'                   => $finding->type,
               'description'            => $finding->description,
               'recommendation'         => $finding->recommendation,
               'resources'              => $finding->resourcesRequired,
               'ECD'                    => $ecdDate,
               'blscr'                  => $finding->securityControlId,
               'threat_level'           => $finding->threatLevel,
               'threat_source'          => $finding->threat,
               'cmeasure_effectiveness' => $finding->countermeasuresEffectiveness,
               'cmeasure'               => $finding->countermeasures);
$complete = true;
foreach ($array as $row) {
    if ($row == '' || $row == 'NONE' || $row == '0000-00-00') {
        $complete = false;
        continue;
    }
}
if ('NEW' == $finding->status || 'DRAFT' == $finding->status) {
    echo "<script type=\"text/javascript\">
                function submitMitigationStrategy(event, obj) {
                    if (form_confirm(document.finding_detail, \"Submit Mitigation Strategy\")) {
                        document.location = \"$postAction/do/submitmitigation\";
                    }
                }
          </script>";
          
    echo '<p><i>The mitigation strategy, security control, and risk analysis sections must
          be fully completed before this can be submitted for approval.</i></p>';

    $submitMitigationButton = new Fisma_Yui_Form_Button('submitMitigation', 
                                                  array('label' => 'Submit Mitigation Strategy', 
                                                        'onClickFunction' => 'submitMitigationStrategy')    );
    if (false == $complete
        || !Fisma_Acl::hasPrivilege('finding', 'mitigation_strategy_submit')
        || in_array($finding->type, array('NONE', 'AR', 'FP'))) {
        $submitMitigationButton->readOnly = true;
    }
    echo "<div class='toolbar'>$submitMitigationButton</div>";
}

if ('EN' == $finding->status && Fisma_Acl::hasPrivilege('finding', 'mitigation_strategy_revise')) {
    echo "<script language=\"javascript\">
            function reviseMitigationStrategy()
            {
                var str = \"The revised mitigation strategy must be fully approved before evidence can be re-submitted. Are you sure that you want to continue?\";
                if(confirm(str) == true){
                    location.href = \"$postAction/do/revisemitigation\";
                }
                return false;
            }
          </script>";
    $reviseMitigationButton = new Fisma_Yui_Form_Button('reviseMitigationButton',
                                                  array('label' => 'Revise Mitigation Strategy', 
                                                        'onClickFunction' => 'reviseMitigationStrategy'));
    echo "<div class='toolbar'>$reviseMitigationButton</div>";
}  

if ($finding->status != 'NEW' 
    && ($finding->status != 'DRAFT' || $finding->FindingEvaluations->count() > 0)) {
    echo '<div class="approval">';
    foreach ($finding->getFindingEvaluations('action') as $findingEvaluation) {
        $userName = $findingEvaluation->User->nameFirst . $findingEvaluation->User->nameLast;
        $decision = $findingEvaluation->decision;
        echo "<p><b>{$findingEvaluation->Evaluation->name}</b>";
        if ('APPROVED' == $decision) {
            echo "<span class=\"approved\">$decision ($userName on {$findingEvaluation->createdTs})</span>";
        }
        if ('DENIED' == $decision) {
            echo "<span class=\"denied\">$decision";
            echo " &mdash; \"{$findingEvaluation->comment}\" ";
            echo "($userName on $findingEvaluation->createdTs)</span>";
        }
        echo "</p>";
        $temp = $findingEvaluation->Evaluation->NextEvaluation->id;
        if (empty($temp) || 'DENIED' == $decision) {
            echo '</div><div class="approval">';
        }
    }

    $activeEvaluation = $finding->CurrentEvaluation;
    if ($activeEvaluation->id != null && $activeEvaluation->approvalGroup == 'action') {
        echo "<p><b>{$activeEvaluation->name}</b>";
        if (Fisma_Acl::hasPrivilege('finding', $activeEvaluation->Privilege->action)) {
            echo '<input type="hidden" name="comment" value="" />';
            echo '<input type="hidden" name="decision" value="APPROVED" />';
            echo '<input name="submit_msa" type="submit" value="APPROVED"
                onclick="return form_confirm(document.finding_detail, \'approve ' . $activeEvaluation->name . '\');"/>&nbsp;';
            echo '<input type="button" value="DENIED" onclick="ms_comment(document.finding_detail);" />';
        } else {
            echo "EXCLUDED";
        }
    }

    $disableEvaluations = array();
    $currentEvaluation  = $finding->CurrentEvaluation;
    if ($currentEvaluation->approvalGroup == 'action') {
        while ($currentEvaluation->nextId != null)  {
            $currentEvaluation    = $currentEvaluation->NextEvaluation;
            $disableEvaluations[] = $currentEvaluation;
        }
    }

    foreach ($disableEvaluations as $evaluation) {
        echo "<p><b>{$evaluation->name}</b>";
        echo "EXCLUDED";
    }
    echo "</div>";
}
Fisma_Format_Section::stopSection(); 
?>
