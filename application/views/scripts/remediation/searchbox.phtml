<?php
    $filter_type = array(0  =>'--Any--',
                    'NONE' =>'(NONE) Unclassified',
                    'CAP'  =>'(CAP) Corrective Action Plan',
                    'AR'   =>'(AR) Accepted Risk',
                    'FP'   =>'(FP) False Positive');
    $onTimes    = array(0 =>'--Any--',
                        'ontime'=>'On Time',
                        'overdue'=>'Overdue');

    $eval = new Evaluation();
    
    $mpEvalList = $eval->getTable()->findByApprovalGroup('action')->toArray();
    $epEvalList = $eval->getTable()->findByApprovalGroup('evidence')->toArray();

    foreach ($mpEvalList as $row) {
        $mpStatus[$row['nickname']] = '('.$row['nickname'].')'.$row['name'];
    }
    foreach ($epEvalList as $row) {
        $epStatus[$row['nickname']] = '('.$row['nickname'].')'.$row['name'];
    }

    $filter_status = array(  0   =>'--Any--',
                           'NEW' =>'(NEW) Awaiting Mitigation Type and Approval',
                           'DRAFT'=>'(DRAFT) Awaiting Mitigation Approval');
    $filter_status = array_merge($filter_status, $mpStatus);
    $filter_status['EN'] = '(EN) Evidence Needed';
    $filter_status = array_merge($filter_status, $epStatus);
    $filter_status['CLOSED'] = '(CLOSED) Officially Closed';
    $filter_status['NOT-CLOSED'] = '(NOT-CLOSED) Not Closed';
    $filter_status['NOUP-30']   = '(NOUP-30) 30+ Days Since Last Update';
    $filter_status['NOUP-60']   = '(NOUP-60) 60+ Days Since Last Update';
    $filter_status['NOUP-90']   = '(NOUP-90) 90+ Days Since Last Update';

    $this->systems = array('--Any--') + (array)$this->systems;
    $this->sources = array('--Any--') + (array)$this->sources;

    $keywordSearch = true;
    if (!is_dir(Fisma::getPath('data') . '/index/finding')) {
        $keywordSearch = false;
    }
?>
<?php //Fisma_Format_Section::startSection("Remediation Search"); ?>

<?php
    $flag = '';
    foreach ($this->params as $k => $value) {
        if (!empty($value) && $k != 'keywords' && $k != 'evidence_include') {
            $flag = 'true';
        }
    }
?>
<form name="filters" method="post" action="/panel/remediation/sub/searchbox">
<table class="searchFilters">
    <tr>
        <td>
            Search: 
        </td>
        <td>
            <input type="text" name="keywords" size="50" value='<?php echo $this->params['keywords'];?>' <?php echo $keywordSearch?'':'disabled="disabled"';?>>
        </td>
        <td><?php echo new Fisma_Yui_Form_Button_Submit('remediationSearchSubmit',
                                                  array('value' => 'Search')); ?></td>
        <td><?php echo new Fisma_Yui_Form_Button('advanced_search',
                                                array('value' => 'Toggle Advanced Search Options',
                                                      'onClickFunction' => 'toggleSearchOptions')); ?></td>
        <td>
            <?php 
            $helpButton = new Fisma_Yui_Form_Button('searchHelp', 
                                              array('value' => 'Help', 
                                                    'imageSrc' => '/images/help.png',
                                                    'onClickFunction' => 'showHelp',
                                                    'onClickArgument' => 'search'));
            echo $helpButton; 
            ?>
        </td>
     </tr>
     <?php if (!$keywordSearch) { ?>
         <tr>
         <td colspan="5">
         <i>The index has not been created yet. You can't use keywords search.</i></td></tr>
     <?php } ?>
</table>

<div id="advanced_searchbox" <?php if ($flag == '') { ?>style="display:none" <?php } ?>>
<!-- Begin Filter Table -->
<table class="searchFilters" style="text-align:left">
    <tr>
        <td><b>Finding Source: </b><br>
            <?php echo $this->formSelect('sourceId',
                                         $this->params['sourceId'],
                                         null,
                                         $this->sources);?>
        </td>
        <td>
        <b>ID: </b><i>(You may select multiple IDs by using a comma separated list - x,y,z)</i><br>
        <input type="text" size="70" name="ids" value="<?php echo $this->params['ids'];?>">
        </td>
    </tr>
    <tr>
        <td ><b> Mitigation Strategy:</b><br>
        <?php echo $this->formSelect('type',
                                     $this->params['type'],
                                     null,
                                     $filter_type);?>
        </td>
        <td width="318" valign="top"><b> Finding Status:</b><br>
        <?php echo $this->formSelect('status', 
                                     $this->params['status'], 
                                     array('id'=>'poamSearchStatus'),
                                     $filter_status);?>
        </td>
    </tr>
    <tr>
        <td><b>Responsible System: </b><br>
            <?php echo $this->formSelect('responsibleOrganizationId',
                                         $this->params['responsibleOrganizationId'],
                                         null,
                                         $this->systems);?>
        </td>
        <td ><b>On Time:</b><br>
            <?php echo $this->formSelect('ontime',
                                         $this->params['ontime'],
                                         array('id'=>'poamSearchOnTime'),
                                         $onTimes);?>
        </td>
    </tr>
    <tr>
        <td colspan='2'>
            <table border="0" cellpadding="3" cellspacing="1" width="98%">
                <tr>
                    <td ><b>Estimated Completion Date:</b></td>
                    <td > From: <input type="text" class="date" id="estDateBegin" name="estDateBegin" value="<?php
                        echo isset($this->params['estDateBegin'])?$this->params['estDateBegin']:'';
                        ?>" size="12" maxlength="10" onfocus="this.blur()"><button type="button" id="estDateBegin_show" title="Show Calendar"><img src="/images/calendar.gif" width="18" height="18" alt="Calendar" ></button></td>
                        
                    <td > To: <input type="text" class="date" id="estDateEnd" name="estDateEnd" value="<?php
                        echo isset($this->params['estDateEnd'])?$this->params['estDateEnd']:'';
                        ?>" size="12" maxlength="10" onfocus="this.blur()"><button type="button" id="estDateEnd_show" title="Show Calendar"><img src="/images/calendar.gif" width="18" height="18" alt="Calendar" ></button></td>
                        
                    <td ><b>Date Created: </b></td>
                    <td > From: <input type="text" class="date" id="createdDateBegin" name="createdDateBegin" value="<?php
                       echo isset($this->params['createdDateBegin'])?$this->params['createdDateBegin']:'';
                        ?>" size="12" maxlength="10" onfocus="this.blur()"><button type="button" id="createdDateBegin_show" title="Show Calendar"><img src="/images/calendar.gif" width="18" height="18" alt="Calendar" ></button></td>
                        
                    <td > To: <input type="text" class="date" id="createdDateEnd" name="createdDateEnd" value="<?php
                        echo isset($this->params['createdDateEnd'])?$this->params['createdDateEnd']:'';
                        ?>" size="12" maxlength="10" onfocus="this.blur()"><button type="button" id="createdDateEnd_show" title="Show Calendar"><img src="/images/calendar.gif" width="18" height="18" alt="Calendar" ></button></td>
                </tr>
            </table>
        </td>
    </tr>
</table>
</form>
</div>

<?php //Fisma_Format_Section::stopSection(); ?>
