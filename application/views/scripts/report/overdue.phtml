<?php
    $currentYear = date('Y');
    $yearList[0] = 'All Fiscal Year';
    for ($year=2005; $year<=$currentYear; $year++) {
        $yearList[$year] = $year;
    }
    $overdue['type'] = array('0' => '--Any--',
                         'sso' => 'Mitigation Strategy',
                         'action'   =>'Corrective Action');
    $overdue['day'] = array('1' => '<30 days',
                            '2' => '30-59 days',
                            '3' => '60-89 days',
                            '4' => '90-119 days',
                            '5' => '120+ days');
    if (!empty($this->systemList)) {
        $this->systemList[0] = '--Any--'; ksort($this->systemList);
    }
    if (!empty($this->sourceList)) {
        $this->sourceList[0] = '--Any--'; ksort($this->sourceList);
    }
    $url = "/panel/report/sub/overdue/s/search";
?>

<form name="overdue_report" method="post" action="/panel/report/sub/overdue/s/search">
    <div class="searchFilters">
        <p>
            <b>System</b>
            <?php 
                $orgSystemSelect = $this->formSelect(
                    'orgSystemId',
                    isset($this->params['orgSystemId']) ? $this->params['orgSystemId'] : 0, 
                    null,
                    $this->systemList
                );
                echo $this->escape($orgSystemSelect, 'none');
                if ( !empty($this->params['orgSystemId']) ) {
                    $url .= '/system_id/'.$this->params['orgSystemId'];
                }
                $generateReportButton = new Fisma_Yui_Form_Button_Submit(
                    'generateOverdueReport',
                    array('label' => 'Generate Report')
                );
                echo $this->escape($generateReportButton, 'none');
                $advancedSearchButton =  new Fisma_Yui_Form_Button(
                    'advanced_search',
                    array(
                        'label' => 'Toggle Advanced Search Options',
                        'onClickFunction' => 'toggleSearchOptions'
                    )
                );
                echo $this->escape($advancedSearchButton, 'none');
            ?>
        </p>
        <?php
        $advancedStyle = (empty($this->params['overdueType']) && empty($this->params['sourceId']))
                       ? 'display:none'
                       : '';
        ?>
        <p id="advanced_searchbox" 
           style="<?php echo $this->escape($advancedStyle, 'none')?>">
            <b>Overdue type</b>
            <?php 
            $overdueTypeSelect = $this->formSelect(
                'overdueType',
                isset($this->params['overdueType']) ? $this->params['overdueType'] : 0,
                null, 
                $overdue['type']
            );
            echo $this->escape($overdueTypeSelect, 'none');
            ?>
            <b>Source</b>
            <?php 
            $sourceSelect = $this->formSelect(
                'sourceId',
                isset($this->params['sourceId'])?$this->params['sourceId']:0, 
                null,
                $this->sourceList
            );
            echo $this->escape($sourceSelect, 'none');
            if ( !empty($this->params['sourceId']) ) {
                $url .= '/sourceId/' . $this->params['sourceId'];
            }
            ?>
        </p>
    </div>
</form>

<?php if ( !empty($this->poamList) ) { ?>
<?php Fisma_Format_Section::startSection("Poam Search Results"); ?>
    <div class="toolbar">
        <?php echo $this->escape($this->links['all'], 'none')?>
        <?php 
            $exportPdfButton = new Fisma_Yui_Form_Button_Link(
                'exportPdf',
                array(
                    'value' => 'Export PDF', 
                    'href' => $this->url.'/format/pdf', 
                    'imageSrc' => '/images/pdf.gif'
                )
            );
            echo $this->escape($exportPdfButton, 'none');
            $exportExcelButton = new Fisma_Yui_Form_Button_Link(
                'exportExcel',
                array(
                    'value' => 'Export Excel', 
                    'href' => $this->url . '/format/xls', 
                    'imageSrc' => '/images/xls.gif'
                )
            );
            echo $this->escape($exportExcelButton, 'none');
        ?>
    </div>
<div id="overdue_report"></div>
<script type="text/javascript">
// Column definitions
var myColumnDefs = [
<?php 
foreach ($this->columns as $key => $val) { 
    if (!isset($i)) {
        $i = true;
    } else {
        echo $this->escape(',', 'none'); 
    }
    
    echo $this->escape("{key:'", 'none');
    echo $this->escape($key);
    echo $this->escape("', label:'", 'none');
    echo $this->escape($val);
    echo $this->escape("', sortable: true, hidden: false}", 'none');
} 
unset($i); 
?>
    ];

    var dataSource = { rows: [
    <?php echo $this->escape(Zend_Json::encode($this->poamList), 'none');?>
    ]};
    
    var myDataSource = new YAHOO.util.DataSource(dataSource.rows);
    
    // DataTable configuration
    var myConfigs = {
        dynamicData: false,
        sortedBy : {key:"orgSystemName", dir:YAHOO.widget.DataTable.CLASS_ASC}
    };
    var myDataTable = new YAHOO.widget.DataTable("overdue_report", myColumnDefs, myDataSource, myConfigs);
    myDataTable.subscribe("rowMouseoverEvent", myDataTable.onEventHighlightRow); 
    myDataTable.subscribe("rowMouseoutEvent", myDataTable.onEventUnhighlightRow);
</script>

<?php 
} 
?>

<?php Fisma_Format_Section::stopSection(); ?>
