Fisma.ControlTree=function(c,b,a){this.treeElem=c;this.actionUrls=b;this.readonly=a?true:false;var d=this;YAHOO.util.Connect.asyncRequest("GET",this.actionUrls.controlTreeData,{success:function(f){var e=YAHOO.lang.JSON.parse(f.responseText);d.showTree(e.treeData);d.updateContextMenus()},failure:function(e){alert("Unable to load the organization tree: "+e.statusText)}},null)};Fisma.ControlTree.prototype={treeView:null,treeElem:null,controlContextMenu:null,controlContextMenuTriggers:null,enhancementContextMenu:null,enhancementContextMenuTriggers:null,actionUrls:null,readonly:null,showTree:function(a){this.treeView=new YAHOO.widget.TreeView(this.treeElem);this.renderTreeNodes(a,this.treeView.getRoot());this.treeView.draw()},renderTreeNodes:function(c,a){for(var b in c){this.renderFamily(b,c[b],a)}},renderFamily:function(e,a,d){var c=new YAHOO.widget.TextNode({label:e,renderHidden:true},d,false);for(var b in a){this.renderControl(a[b],c)}},renderControl:function(f,e){var b="<b>"+PHP_JS().htmlspecialchars(f.code)+"</b> - <i>"+PHP_JS().htmlspecialchars(f.name)+"</i>";if(f.common){b+=" (Common)"}else{if(f.inherits!=null){b+=" (Inherits From "+f.inherits+")"}}var d={label:b,renderHidden:true,securityControlId:f.id,controlCode:PHP_JS().htmlspecialchars(f.code)};var a=new YAHOO.widget.TextNode(d,e,false);if(!this.readonly){if(this.controlContextMenuTriggers==null){this.controlContextMenuTriggers=[]}this.controlContextMenuTriggers.push(a.labelElId)}for(var c in f.enhancements){this.renderEnhancement(f.enhancements[c],a)}},renderEnhancement:function(b,d){var a=d.data.controlCode+" ("+b.number+")";var c={label:a,renderHidden:true,securityControlEnhancementId:b.id};var e=new YAHOO.widget.TextNode(c,d,false);if(!this.readonly){if(this.enhancementContextMenuTriggers==null){this.enhancementContextMenuTriggers=[]}this.enhancementContextMenuTriggers.push(e.labelElId)}},updateContextMenus:function(){if(this.readonly){return}if(this.controlContextMenu==null){var b=[{text:"Remove Control",value:"removeControl"},{text:"Add Enhancements",value:"addEnhancements"},{text:"Edit Common Control",value:"editCommonControl"}];this.controlContextMenu=new YAHOO.widget.ContextMenu("controlContextMenu",{trigger:this.controlContextMenuTriggers,lazyload:true,itemData:b});this.controlContextMenu.subscribe("click",this.onContextMenuClick,this)}else{this.controlContextMenu.cfg.setProperty("trigger",this.controlContextMenuTriggers)}if(this.enhancementContextMenu==null){var a=[{text:"Remove Enhancement",value:"removeEnhancement"}];this.enhancementContextMenu=new YAHOO.widget.ContextMenu("enhancementContextMenu",{trigger:this.enhancementContextMenuTriggers,lazyload:true,itemData:a});this.enhancementContextMenu.subscribe("click",this.onContextMenuClick,this)}else{this.enhancementContextMenu.cfg.setProperty("trigger",this.enhancementContextMenuTriggers)}},onContextMenuClick:function(b,a,f){var d=f,e=d.treeView.getNodeByElement(this.contextEventTarget),c=a[1];switch(c.value){case"removeControl":d.removeControl(e);break;case"addEnhancements":d.addEnhancements(e);break;case"removeEnhancement":d.removeEnhancement(e);break;case"editCommonControl":d.editCommonControl(e);break;default:alert("Action not yet implemented.")}},removeControl:function(e){var f=e.data.securityControlId,d=this.actionUrls.removeControl,b="securityControlId="+f,a=e.parent,g=this;var c={success:function(i){var h=YAHOO.lang.JSON.parse(i.responseText);if(h.result=="ok"){g.treeView.removeNode(e,true);g.updateContextMenus()}else{alert(h.result)}},failure:function(h){alert("Unable to remove the control tree: "+h.statusText)}};YAHOO.util.Connect.asyncRequest("POST",d,c,b)},removeEnhancement:function(d){var f=d.data.securityControlEnhancementId,c=this.actionUrls.removeEnhancement,a="securityControlEnhancementId="+f,e=this;var b={success:function(h){var g=YAHOO.lang.JSON.parse(h.responseText);if(g.result=="ok"){e.treeView.removeNode(d,true);e.updateContextMenus()}else{alert(g.result)}},failure:function(g){alert("Unable to remove the control tree: "+g.statusText)}};YAHOO.util.Connect.asyncRequest("POST",c,b,a)},addEnhancements:function(a){var f=a.data.securityControlId,b=Fisma.HtmlPanel.showPanel("Add Security Control",null,null,{modal:true}),e=this.actionUrls.addEnhancements,c=e+"/securityControlId/"+f,g=this;var d={success:function(i){var h=i.argument;h.setBody(i.responseText);h.center()},failure:function(i){var h=i.argument;h.destroy();alert('Error getting "add control" form: '+i.statusText)},argument:b};YAHOO.util.Connect.asyncRequest("GET",c,d)},editCommonControl:function(a){var f=a.data.securityControlId,b=Fisma.HtmlPanel.showPanel("Edit Common Security Control",null,null,{modal:true}),e=this.actionUrls.editCommonControl,c=e+"/securityControlId/"+f,g=this;var d={success:function(i){var h=i.argument;h.setBody(i.responseText);h.center()},failure:function(i){var h=i.argument;h.destroy();alert('Error getting "edit common control" form: '+i.statusText)},argument:b};YAHOO.util.Connect.asyncRequest("GET",c,d)}};