(function(){var b=YAHOO.util.Dom,i=YAHOO.util.Event,c=YAHOO.lang,g=YAHOO.widget.DataTable,f="__NESTED__",h="__NESTED_TABLE__",d="__MASTER_TABLE__",a="generateNestedRequest";var e=function(o,j,l,n,m,k,p){this._nestedColDefs=n;this._nestedDataSource=m;this._nestedOptions=p||{};j.unshift({key:f,label:" ",className:f,formatter:this._toggleFormatter});e.superclass.constructor.call(this,o,j,l,k);b.addClass(this.getTableEl(),d);this.on("cellClickEvent",this._onEventToggleNested);this.on("renderEvent",this._onMasterRendered);i.on(window,"resize",this._onWindowResized,this,true);this.on("rowDeleteEvent",this._onRowDeleteDestroyNested);this.on("rowsDeleteEvent",this._onRowsDeleteDestroyNested)};YAHOO.widget.NestedDataTable=e;c.extend(e,g,{initAttributes:function(j){e.superclass.initAttributes.apply(this,arguments);this.setAttributeConfig(a,{value:null,validator:c.isFunction})},_forAllNested:function(n){var k=this.getRecordSet(),o=k.getLength(),j,m;for(var l=0;l<o;l++){j=k.getRecord(l);if(j){m=j.getData(f);if(m){n.call(this,m,j)}}}},_checkPositions:function(){this._forAllNested(function(k,j){if(k.expanded){b.setY(k.div,b.getY(k.td)+k.tdOrigHeight);this.fireEvent("nestedMovedEvent",k)}})},_toggleFormatter:function(k,l,m,n){var j=n&&n.expanded;if(j){b.replaceClass(k,"expand","collapse")}else{b.replaceClass(k,"collapse","expand")}k.innerHTML='<a href="#" aria-role="button" aria-pressed="'+(j?"true":"false")+'"> &nbsp; </a>'},_onEventToggleNested:function(n){var o=n.target,m=n.event,j=this.getRecord(o),l=this.getColumn(o);if(l.key==f){i.stopEvent(m);var p=this.getFirstTdEl(j),k=j.getData(f);if(!k){j.setData(f,{td:p,expanded:true});this._makeNestedTable(j)}else{if(k.expanded){k.expanded=false;b.setStyle(p,"height",null);b.setStyle(k.div,"display","none")}else{k.expanded=true;b.setStyle(p,"height",k.tdNewHeight+"px");b.setStyle(k.div,"display","");if(k.setHorizPos){b.setX(k.div,b.getX(p)+b.getRegion(p).width);k.setHorizPos=false}}this.fireEvent("nestedToggleEvent",k);this._checkPositions()}this.formatCell(this.getTdLinerEl(o),j,l);return false}},_onMasterRendered:function(){this._forAllNested(function(k,j){k.td=this.getFirstTdEl(j);if(k.td){if(k.expanded){b.setStyle(k.td,"height",k.tdNewHeight+"px")}}else{k.expanded=false;b.setStyle(k.div,"display","none")}});this._checkPositions()},_onWindowResized:function(j){this._forAllNested(function(l,k){var m=l.td;if(l.expanded){b.setX(l.div,b.getX(m)+b.getRegion(m).width)}else{l.setHorizPos=true}});this._checkPositions()},_makeNestedTable:function(j){var l=j.getData(f),n=this.get(a),k=this;this._nestedOptions.initialRequest=(n?n.call(this,j):this._nestedOptions.initialRequest);if(this._nestedOptions.initialRequest){var o=document.body.appendChild(document.createElement("div"));b.addClass(o,h);var m=new g(o,this._nestedColDefs,this._nestedDataSource,this._nestedOptions);m.on("initEvent",function(){var t=l.td;var q=b.getRegion(t),r=q.height,s=q.width,p=b.getRegion(t.parentNode).width;l.tdOrigHeight=r;b.setStyle(o,"width",(p-s+2)+"px");l.tdNewHeight=r+b.getRegion(o).height;b.setStyle(t,"height",l.tdNewHeight+"px");b.setX(o,b.getX(t)+s);k._checkPositions()});l.div=o;l.dt=m;this.fireEvent("nestedCreateEvent",l)}},_destroyNested:function(j){if(j){this.fireEvent("nestedDestroyEvent",j);j.dt.destroy();j.div.parentNode.removeChild(j.div)}},initializeTable:function(){this._forAllNested(this._destroyNested);e.superclass.initializeTable.apply(this,arguments)},onDataReturnSetRows:function(){this._forAllNested(this._destroyNested);e.superclass.onDataReturnSetRows.apply(this,arguments)},_onRowDeleteDestroyNested:function(j){this._destroyNested(j.oldData[f])},_onRowsDeleteDestroyNested:function(k){for(var j=0;j<k.oldData.length;j++){this._destroyNested(k.oldData[j][f])}}})})();